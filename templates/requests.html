{% extends "base.html" %}

{% block title %}Requests Board - Game Sharing Platform{% endblock %}

{% block content %}
<h2>Requests Board</h2>
<p>This is a global board for feature requests, feedback, and general discussion. Everyone can post!</p>

<hr>

<!-- Filter UI -->
<div style="margin-bottom: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
    <form method="GET" action="{{ url_for('requests_board') }}" style="display: inline;">
        <label for="tag_filter">Filter by tag:</label>
        <select name="tag_filter" id="tag_filter" onchange="this.form.submit()">
            <option value="all" {% if not tag_filter or tag_filter == 'all' %}selected{% endif %}>All</option>
            <option value="no_tag" {% if tag_filter == 'no_tag' %}selected{% endif %}>No Tag</option>
            <option value="feedback" {% if tag_filter == 'feedback' %}selected{% endif %}>感想 (Feedback)</option>
            <option value="bug" {% if tag_filter == 'bug' %}selected{% endif %}>バグ報告 (Bug)</option>
            <option value="request" {% if tag_filter == 'request' %}selected{% endif %}>要望 (Request)</option>
            <option value="discussion" {% if tag_filter == 'discussion' %}selected{% endif %}>仕様・議論 (Discussion)</option>
        </select>

        {% if is_admin %}
            <label for="show_deleted" style="margin-left: 15px;">
                <input type="checkbox" name="show_deleted" id="show_deleted" value="true"
                       {% if show_deleted %}checked{% endif %} onchange="this.form.submit()">
                Show Deleted (Admin)
            </label>
        {% endif %}
    </form>
</div>

<!-- Main comment form -->
<h3>Post a New Request or Comment</h3>
<form method="POST" action="{{ url_for('post_request_comment') }}">
    <textarea name="content" rows="4" cols="50" placeholder="Write your request or comment..." required maxlength="1000"></textarea>
    <br>
    <label for="tag">Tag (optional):</label>
    <select name="tag" id="tag">
        <option value="">-- No Tag --</option>
        <option value="feedback">感想 (Feedback)</option>
        <option value="bug">バグ報告 (Bug Report)</option>
        <option value="request">要望 (Request)</option>
        <option value="discussion">仕様・議論 (Discussion)</option>
    </select>
    <br>
    <button type="submit">Post</button>
</form>

<hr>
<h3>All Posts</h3>

<!-- Display comments -->
{% if comments %}
    {% macro render_comment(comment, depth=0) %}
    <div style="margin-left: {{ depth * 20 }}px; margin-top: 15px; padding: 10px; border-left: 2px solid {% if comment.is_deleted %}#ff6b6b{% else %}#ccc{% endif %}; {% if comment.is_deleted %}background-color: #ffe0e0;{% endif %}">
        <p>
            {% if comment.is_deleted %}
                <strong style="color: #ff0000;">[DELETED]</strong>
            {% endif %}
            {% if comment.tag == 'feedback' %}
                <strong>[感想]</strong>
            {% elif comment.tag == 'bug' %}
                <strong>[バグ報告]</strong>
            {% elif comment.tag == 'request' %}
                <strong>[要望]</strong>
            {% elif comment.tag == 'discussion' %}
                <strong>[議論]</strong>
            {% endif %}
            <strong>
                {% if comment.user_id %}
                    {{ comment.author.username }}({{ comment.author.id }})
                {% else %}
                    {{ comment.guest_name }}
                {% endif %}
            </strong>
            <small>{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            {% if is_admin and comment.reports|length > 0 %}
                <strong style="color: #ff6600; margin-left: 10px;">Reports: {{ comment.reports|length }}</strong>
            {% endif %}
        </p>
        {% if comment.is_deleted %}
            <p style="color: #666; font-style: italic;">[Content deleted{% if comment.delete_reason %}: {{ comment.delete_reason }}{% endif %}]</p>
        {% else %}
            <p>{{ comment.content }}</p>
        {% endif %}

        {% if not comment.is_deleted %}
            <button onclick="toggleReplyForm('reply-form-{{ comment.id }}')">Reply</button>
            <form method="POST" action="{{ url_for('report_comment', comment_id=comment.id) }}" style="display: inline; margin-left: 10px;">
                <button type="submit" style="color: #ff6600;" onclick="return confirm('Report this comment?')">Report</button>
            </form>
        {% endif %}

        {% if is_admin %}
            <!-- Admin can delete/restore -->
            {% if comment.is_deleted %}
                <form method="POST" action="{{ url_for('restore_comment', comment_id=comment.id) }}" style="display: inline; margin-left: 10px;">
                    <button type="submit" style="color: green;">Restore</button>
                </form>
            {% else %}
                <button onclick="toggleDeleteForm('delete-form-{{ comment.id }}')" style="color: red; margin-left: 10px;">Delete</button>
                <div id="delete-form-{{ comment.id }}" style="display: none; margin-top: 5px;">
                    <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" style="display: inline;">
                        <input type="text" name="reason" placeholder="Reason (optional)" size="30">
                        <button type="submit" style="color: red;">Confirm Delete</button>
                        <button type="button" onclick="toggleDeleteForm('delete-form-{{ comment.id }}')">Cancel</button>
                    </form>
                </div>
            {% endif %}
        {% endif %}

        <!-- Reply form (hidden by default) -->
        <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px;">
            <form method="POST" action="{{ url_for('post_request_comment') }}">
                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                <textarea name="content" rows="3" cols="40" placeholder="Write a reply..." required maxlength="1000"></textarea>
                <br>
                <label for="tag-reply-{{ comment.id }}">Tag (optional):</label>
                <select name="tag" id="tag-reply-{{ comment.id }}">
                    <option value="">-- No Tag --</option>
                    <option value="feedback">感想 (Feedback)</option>
                    <option value="bug">バグ報告 (Bug Report)</option>
                    <option value="request">要望 (Request)</option>
                    <option value="discussion">仕様・議論 (Discussion)</option>
                </select>
                <br>
                <button type="submit">Post Reply</button>
                <button type="button" onclick="toggleReplyForm('reply-form-{{ comment.id }}')">Cancel</button>
            </form>
        </div>

        <!-- Render replies recursively -->
        {% if comment.replies %}
            {% for reply in comment.replies|sort(attribute='created_at') %}
                {{ render_comment(reply, depth + 1) }}
            {% endfor %}
        {% endif %}
    </div>
    {% endmacro %}

    {% for comment in comments %}
        {{ render_comment(comment) }}
    {% endfor %}
{% else %}
    <p>No posts yet. Be the first to post!</p>
{% endif %}

<script>
function toggleReplyForm(formId) {
    var form = document.getElementById(formId);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}

function toggleDeleteForm(formId) {
    var form = document.getElementById(formId);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}
</script>

<p><a href="{{ url_for('index') }}">Back to home</a></p>
{% endblock %}
