{% extends "base.html" %}

{% block title %}{{ game.title }} - Game Sharing Platform{% endblock %}

{% block content %}
<h2>{{ game.title }}</h2>

<p><strong>Author:</strong> {{ game.uploader.username }}</p>
<p><strong>Uploaded:</strong> {{ game.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
<p><strong>Description:</strong></p>
<p>{{ game.description or 'No description provided.' }}</p>

<p>
    <a href="{{ url_for('download_game', game_id=game.id) }}">Download Game</a>
</p>

<hr>
<h3>Comments</h3>

<!-- Filter UI -->
<div style="margin-bottom: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
    <form method="GET" action="{{ url_for('game_detail', game_id=game.id) }}" style="display: inline;">
        <label for="tag_filter">Filter by tag:</label>
        <select name="tag_filter" id="tag_filter" onchange="this.form.submit()">
            <option value="all" {% if not tag_filter or tag_filter == 'all' %}selected{% endif %}>All</option>
            <option value="no_tag" {% if tag_filter == 'no_tag' %}selected{% endif %}>No Tag</option>
            <option value="feedback" {% if tag_filter == 'feedback' %}selected{% endif %}>感想 (Feedback)</option>
            <option value="bug" {% if tag_filter == 'bug' %}selected{% endif %}>バグ報告 (Bug)</option>
            <option value="request" {% if tag_filter == 'request' %}selected{% endif %}>要望 (Request)</option>
            <option value="discussion" {% if tag_filter == 'discussion' %}selected{% endif %}>仕様・議論 (Discussion)</option>
        </select>

        {% if is_author %}
            <label for="show_hidden" style="margin-left: 15px;">
                <input type="checkbox" name="show_hidden" id="show_hidden" value="true"
                       {% if show_hidden %}checked{% endif %} onchange="this.form.submit()">
                Show Hidden
            </label>
        {% endif %}

        {% if is_admin %}
            <label for="show_deleted" style="margin-left: 15px;">
                <input type="checkbox" name="show_deleted" id="show_deleted" value="true"
                       {% if show_deleted %}checked{% endif %} onchange="this.form.submit()">
                Show Deleted (Admin)
            </label>
        {% endif %}
    </form>
</div>

<!-- Main comment form -->
<form method="POST" action="{{ url_for('post_comment', game_id=game.id) }}">
    <textarea name="content" rows="4" cols="50" placeholder="Write a comment..." required maxlength="1000"></textarea>
    <br>
    <label for="tag">Tag (optional):</label>
    <select name="tag" id="tag">
        <option value="">-- No Tag --</option>
        <option value="feedback">感想 (Feedback)</option>
        <option value="bug">バグ報告 (Bug Report)</option>
        <option value="request">要望 (Request)</option>
        <option value="discussion">仕様・議論 (Discussion)</option>
    </select>
    <br>
    <button type="submit">Post Comment</button>
</form>

<!-- Display comments -->
{% if comments %}
    {% macro render_comment(comment, depth=0) %}
    <div style="margin-left: {{ depth * 20 }}px; margin-top: 15px; padding: 10px; border-left: 2px solid {% if comment.is_deleted %}#ff6b6b{% else %}#ccc{% endif %}; {% if comment.is_deleted %}background-color: #ffe0e0;{% endif %}">
        <p>
            {% if comment.is_deleted %}
                <strong style="color: #ff0000;">[DELETED]</strong>
            {% endif %}
            {% if comment.tag == 'feedback' %}
                <strong>[感想]</strong>
            {% elif comment.tag == 'bug' %}
                <strong>[バグ報告]</strong>
            {% elif comment.tag == 'request' %}
                <strong>[要望]</strong>
            {% elif comment.tag == 'discussion' %}
                <strong>[議論]</strong>
            {% elif comment.tag == 'hidden' %}
                <strong style="color: #999;">[非表示 Hidden]</strong>
            {% endif %}
            <strong {% if comment.user_id == game.uploader_id %}style="background-color: #d3d3d3; padding: 2px 5px; border-radius: 3px;"{% endif %}>
                {% if comment.user_id %}
                    {{ comment.author.username }}({{ comment.author.id }})
                    {% if comment.user_id == game.uploader_id %}
                        ★
                    {% endif %}
                {% else %}
                    {{ comment.guest_name }}
                {% endif %}
            </strong>
            <small>{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            {% if is_admin and comment.reports|length > 0 %}
                <strong style="color: #ff6600; margin-left: 10px;">Reports: {{ comment.reports|length }}</strong>
            {% endif %}
        </p>
        {% if comment.is_deleted %}
            <p style="color: #666; font-style: italic;">[Content deleted{% if comment.delete_reason %}: {{ comment.delete_reason }}{% endif %}]</p>
        {% else %}
            <p>{{ comment.content }}</p>
        {% endif %}

        {% if not comment.is_deleted %}
            <button onclick="toggleReplyForm('reply-form-{{ comment.id }}')">Reply</button>
            <form method="POST" action="{{ url_for('report_comment', comment_id=comment.id) }}" style="display: inline; margin-left: 10px;">
                <button type="submit" style="color: #ff6600;" onclick="return confirm('Report this comment?')">Report</button>
            </form>
        {% endif %}

        {% if is_author and not comment.is_deleted %}
            <!-- Author can change tag -->
            <form method="POST" action="{{ url_for('change_comment_tag', game_id=game.id, comment_id=comment.id) }}" style="display: inline; margin-left: 10px;">
                <label for="new-tag-{{ comment.id }}">Change tag:</label>
                <select name="new_tag" id="new-tag-{{ comment.id }}" onchange="this.form.submit()">
                    <option value="">-- No Tag --</option>
                    <option value="feedback" {% if comment.tag == 'feedback' %}selected{% endif %}>感想</option>
                    <option value="bug" {% if comment.tag == 'bug' %}selected{% endif %}>バグ</option>
                    <option value="request" {% if comment.tag == 'request' %}selected{% endif %}>要望</option>
                    <option value="discussion" {% if comment.tag == 'discussion' %}selected{% endif %}>議論</option>
                    <option value="hidden" {% if comment.tag == 'hidden' %}selected{% endif %}>非表示</option>
                </select>
            </form>
        {% endif %}

        {% if is_admin %}
            <!-- Admin can delete/restore -->
            {% if comment.is_deleted %}
                <form method="POST" action="{{ url_for('restore_comment', comment_id=comment.id) }}" style="display: inline; margin-left: 10px;">
                    <button type="submit" style="color: green;">Restore</button>
                </form>
            {% else %}
                <button onclick="toggleDeleteForm('delete-form-{{ comment.id }}')" style="color: red; margin-left: 10px;">Delete</button>
                <div id="delete-form-{{ comment.id }}" style="display: none; margin-top: 5px;">
                    <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" style="display: inline;">
                        <input type="text" name="reason" placeholder="Reason (optional)" size="30">
                        <button type="submit" style="color: red;">Confirm Delete</button>
                        <button type="button" onclick="toggleDeleteForm('delete-form-{{ comment.id }}')">Cancel</button>
                    </form>
                </div>
            {% endif %}
        {% endif %}

        <!-- Reply form (hidden by default) -->
        <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px;">
            <form method="POST" action="{{ url_for('post_comment', game_id=game.id) }}">
                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                <textarea name="content" rows="3" cols="40" placeholder="Write a reply..." required maxlength="1000"></textarea>
                <br>
                <label for="tag-reply-{{ comment.id }}">Tag (optional):</label>
                <select name="tag" id="tag-reply-{{ comment.id }}">
                    <option value="">-- No Tag --</option>
                    <option value="feedback">感想 (Feedback)</option>
                    <option value="bug">バグ報告 (Bug Report)</option>
                    <option value="request">要望 (Request)</option>
                    <option value="discussion">仕様・議論 (Discussion)</option>
                </select>
                <br>
                <button type="submit">Post Reply</button>
                <button type="button" onclick="toggleReplyForm('reply-form-{{ comment.id }}')">Cancel</button>
            </form>
        </div>

        <!-- Render replies recursively -->
        {% if comment.replies %}
            {% for reply in comment.replies|sort(attribute='created_at') %}
                {{ render_comment(reply, depth + 1) }}
            {% endfor %}
        {% endif %}
    </div>
    {% endmacro %}

    {% for comment in comments %}
        {{ render_comment(comment) }}
    {% endfor %}
{% else %}
    <p>No comments yet. Be the first to comment!</p>
{% endif %}

<script>
function toggleReplyForm(formId) {
    var form = document.getElementById(formId);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}

function toggleDeleteForm(formId) {
    var form = document.getElementById(formId);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}
</script>

{% if current_user.is_authenticated and current_user.id == game.uploader_id %}
    <hr>
    <h3>Author Actions</h3>
    <p>
        <a href="{{ url_for('edit_game', game_id=game.id) }}">Edit Game</a>
    </p>
    <form method="POST" action="{{ url_for('delete_game', game_id=game.id) }}" style="display:inline;">
        <button type="submit" onclick="return confirm('Are you sure you want to delete this game?')">Delete Game</button>
    </form>
{% endif %}

<p><a href="{{ url_for('index') }}">Back to game list</a></p>
{% endblock %}
